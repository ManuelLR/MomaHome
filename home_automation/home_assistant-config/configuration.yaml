homeassistant:
  # Name of the location where Home Assistant is running
  name: MomaHome
  # Location required to calculate the time the sun rises and sets
  latitude: !secret momahome_latitude
  longitude: !secret momahome_longitude
  # Impacts weather/sunrise data (altitude above sea level in meters)
  elevation: !secret momahome_elevation
  # metric for Metric, imperial for Imperial
  unit_system: metric
  # Pick yours from here: http://en.wikipedia.org/wiki/List_of_tz_database_time_zones
  time_zone: Europe/Madrid
  # Customization file
  customize: !include customize.yaml
  auth_mfa_modules:
    - type: totp
      name: Authenticator app
    - type: notify
      message: 'Hey, that is your access code: `{}`'

logger:
  default: info
  logs:
    homeassistant.components.nmap_tracker.device_tracker: warn

lovelace:
  mode: yaml

recorder:
  db_url: !secret recorder_db_url
  purge_keep_days: 30
  purge_interval: 3
  # include:
  exclude:
    # domains:
    #   - automation
    #   - weblink
    #   - updater
    entities:
      - sun.sun # Don't record sun data
      # - sensor.last_boot # Comes from 'systemmonitor' sensor platform
      # - sensor.date

# Configure a default setup of Home Assistant (frontend, api, etc)
default_config:

# Uncomment this if you are using SSL/TLS, running in Docker container, etc.
http:
  server_port: 8123
#   base_url: example.duckdns.org:8123

duckdns:
  domain: !secret duckdns_domains
  access_token: !secret duckdns_token

# Discover some devices automatically
discovery:

mqtt:
  broker: 192.168.200.7
  port: 1883
  client_id: homeassistant
  # username:
  # password:

pi_hole:
  host: 192.168.200.9
  #monitored_conditions:
    #- ads_blocked_today
    #- ads_percentage_today
    #- dns_queries_today
    #- domains_being_blocked
    #- queries_cached
    #- queries_forwarded
    #- unique_clients
    #- unique_domains

# Sensors
sensor:
  # Weather prediction
  - platform: yr
  - platform: mqtt
    name: "man-001 Voltage"
    state_topic: "man-001/espurna/voltage"
    qos: "1"
    # icon:
    # availability_topic
    # payload_available
    # value_template: "{{ value_json.Voltage }}"
    # device
    unit_of_measurement: "V"
    device:
      identifiers: man-001
      name: Living room light socket
  - platform: mqtt
    name: "man-001 Current A"
    qos: "1"
    state_topic: "man-001/espurna/current"
    # value_template: "{{ value_json.Today }}"
    unit_of_measurement: "A"
    device:
      identifiers: man-001
      name: Living room light socket
  - platform: mqtt
    name: "man-001 Energy"
    qos: "1"
    state_topic: "man-001/espurna/energy"
    # value_template: "{{ value_json.Today }}"
    unit_of_measurement: "kWh"
    device:
      identifiers: man-001
      name: Living room light socket
  - platform: mqtt
    name: "man-001 Power"
    qos: "1"
    state_topic: "man-001/espurna/power"
    # value_template: "{{ value_json.Power }}"
    unit_of_measurement: "W"
    device:
      identifiers: man-001
      name: Living room light socket
  - platform: mqtt
    name: "man-001 Power factor"
    qos: "1"
    state_topic: "man-001/espurna/factor"
    # value_template: "{{ value_json.Voltage }}"
    unit_of_measurement: "%"
    device:
      identifiers: man-001
      name: Living room light socket
  - platform: miflora
    name: "flora-001"
    force_update: yes
    scan_interval: 2400
    mac: !secret sensor_miflora_mac

  # https://philhawthorne.com/making-home-assistants-presence-detection-not-so-binary/
  - platform: template
    sensors:
      manolo_status:
        value_template: '{{ states.input_select.manolo_status_dropdown.state }}'
        friendly_name: 'Manolo'
      monica_status:
        value_template: '{{ states.input_select.monica_status_dropdown.state }}'
        friendly_name: 'Monica'
      home_occupancy_status:
        value_template: '{{ states.input_select.home_occupancy_status_dropdown.state }}'
        friendly_name: 'Home Occupancy'
  - platform: apcupsd
    resources:
       - bcharge
         # - linev

  - platform: snmp
    # https://community.home-assistant.io/t/monitor-dd-wrt-cpu-temp-load-and-free-ram-how-i-did-it/140470
    name: Router CPU Load
    host: 192.168.200.1
    community: !secret DDWRT_SNMP_RO
      # https://wiki.dd-wrt.com/wiki/index.php/SNMP
    baseoid: 1.3.6.1.4.1.2021.10.1.5.1
    accept_errors: true
    unit_of_measurement: '%'
    # Dual CPU, so if value is 200, it means 100%, so divide by 2
    value_template: '{{ (value | int) / 2 | round(1) }}'

  - platform: snmp
    # https://community.home-assistant.io/t/monitor-dd-wrt-cpu-temp-load-and-free-ram-how-i-did-it/140470
    name: Router RAM Free
    host: 192.168.200.1
    community: !secret DDWRT_SNMP_RO
    baseoid: 1.3.6.1.4.1.2021.4.11.0
    accept_errors: true
    unit_of_measurement: 'MB'
    value_template: '{{ value | multiply(0.001) | round(1) }}'

device_tracker:
  - platform: nmap_tracker
    interval_seconds: 180
    hosts: 192.168.200.0/24
    # consider_home: 600
    consider_home: 400
    # consider_home: 350
    # consider_home: 30
    new_device_defaults: &new-device-defaults
      track_new_devices: true
      hide_if_away: true
  # - platform: bluetooth_tracker
  #   new_device_defaults: *new-device-defaults
  - platform: tile
    username: !secret tile_username
    password: !secret tile_password
    show_inactive: true
  - platform: ddwrt
    host: 192.168.200.1
    ssl: true
    verify_ssl: false
    consider_home: 400
    wireless_only: true
    username: !secret DDWRT_USERNAME
    password: !secret DDWRT_PASSWORD
    new_device_defaults: *new-device-defaults

input_select:
  # https://philhawthorne.com/making-home-assistants-presence-detection-not-so-binary/
  home_occupancy_status_dropdown:
    name: Home Occupancy
    options: &person_status
      - Home
      - Just Arrived
      - Just Left
      - Away
      - Extended Away
    # initial: Home
  monica_status_dropdown:
    name: Monica
    options: *person_status
  manolo_status_dropdown:
    name: Manolo
    options: *person_status
  vacuum_zone_room_selected:
    name: Choose a room to clean
    icon: mdi:image-size-select-small
    options:
      - eat area
      - bathroom
      - kitchen
      - living room
      - bedroom
      - study room
      - corridor
      - hall
  vacuum_zone_fan_speed:
    name: Choose a fan speed to clean at
    icon: mdi:fan
    options:
      - Balanced
      - Quiet
      - Turbo
      - Max

input_number:
  vacuum_xiaomi_dust_clean_left:
    min: 0
    # max: 140
    max: 250
    unit_of_measurement: square meter
    icon: mdi:basket-fill
    mode: slider
  vacuum_zone_repeats:
    name: NÂº repeats (vacuum zone)
    icon: mdi:repeat
    min: 1
    max: 3
    step: 1
    initial: 1
    mode: box


# Text to speech
tts:
  - platform: google_translate
    service_name: google_say

telegram_bot:
  - platform: polling
    api_key: !secret telegram_api_key
    allowed_chat_ids:
      - !secret telegram_userid_manolo
      - !secret telegram_userid_monica

timer:
  power_socket_double_001_left:
  power_socket_double_001_right:


input_datetime:
  timer_power_socket_double_001_left:
    has_time: true
  timer_power_socket_double_001_right:
    has_time: true

vacuum:
  # https://www.home-assistant.io/components/vacuum.xiaomi_miio/
  - name: Xiaomi Vacuum
    platform: xiaomi_miio
    host: 192.168.200.50
    token: !secret xiaomi_vacuum_token_0

# espurna--man-001.local.
switch:
  - friendly_name: IR living room
    platform: broadlink
    host: 192.168.200.51
    mac: !secret switch_ir_living_room_mac
    # timeout: 60
    # type: rm_mini
    switches:
      tv_samsung_on:
        friendly_name: "TV on"
        command_on: 'JgCwBBE5EjoSOREABW+TlxE5EjoSOBEVEhQRFBAVEhMSORI6EDoTExEVEhQQFhEUEhUQOxEUERURFREVEhQQFhE5ExITOhI4ETgSOhE5EDoRAAVtlZYSORI5EToRFRAVERUSFBAWEToQORE5ERURFRMTEBQRFhEVETkRFRIUERQRFRAWERQROhIUEDsSOhE5EjkROxE4EgAFbpaXETkSOBE6EBUSFBEWEhMRFhE5EjkROxEUERURFREUEBYQFhA5ERYQFREVEBURFBIUEjkSExE6EjgSOhI5EjgRORMABW2VlxI4EToRORIVEBURFBEVEBQSOhI4EjgSFhAVERQRFRITExQQORIUEhQRFREVEBURFRE6EBQROhI4EjkRORI5EjkSAAVvlJYSORE4FDkSExIVERQSFBIUEjgSOhE5ERURFREUEhQRFREVETkSFBEVEBYRFREUERUROhIUEToRORI5EjgSOhI5EQAFbpaVETsSOBI6ERQRFBEWEBQRFRI5EjkSORITEhYQFRAVERURFBI5EhQRFREUERURFREUEjkSFBE6ETkSOBI7EDkROhIABW2WlhI4EzkROBIVERURFRAWERUROhE6ETgRFBIVERQRFREVEhYQOREWEBUQFRIUEhMRFRI4EhYQORI5EzcROhI5EjoSAAVtlJgSORE5EjoRFBITEhMSFREWETgSOxE5ERURFBEUEhUQFhEUEjkSExIVERURFRAVERUROREVEzgROxA6EDoSOBI5EQAFbpWWEToSOBM4ERUSFREVEBUQFRM4EjkROhEVERUQFREVERYRFBE6ERUSExIUERURFBEWEToRFBI5EjkSORM3DzwROhEABW+VlhE5EToSOREVEhUQFRAVERUSORI5EToRFBEUERYQFRIUEhQROhIVERQRFBIUERURFRA7EBQSOhE5EToRORM4EToQAAVulpcRORI5EDsSExAVERQSExIUEjkTOBI5EhQRFRAVERQRFRIUEToSFBEUEhQRFRAUERUSOREVEToQORM5EToRORM4EQAFb5WXEjkQORE6EhQRFREVEhMRFhE5ETkTOhETExQRFRAVEBUTFRE4ERUSFBETExQRFhEUEToRFRE6EDoROhE5ETkROxEABXCUlhM3EjsROREVEhQRFRAWERUQOhE6EjgRFBIUEhQRFhAVERUROhITERYRFBEUEhQSFBE6EhQROxA6ETkSORI5EjkSAAVulZYROxE5EjgRFREUERQTFBAWETkSORE5EhURFBEVERUSFBEUEToTExEVERURFBEUEhYQOhEUEjgTORI4EToSORI6EgAFbJaWEjkSORE4EhQSFBEVERQSFBI4EjkSOhEVEhMRFREVERUQFRE5EhURFBIWDxUQFRIUFDcRFRI3EjoSORI5EjYVOREABXCTlhI6EjgSORIWDxUSFBAVEhQSORE6ETkSFBIUERURFBIUEhUQOhEVERUQFRIUEhQRFRE6EhQSOhE5EjkROhM4EToRAAVulZYSORI5EjkTExEVEBUTFBAVEDwQORE7EhMSFBEUEhURFREVEDoRFREVERYQFRIUEhQRORIUEjgSORI5EjoSOBM4EAANBQAAAAAAAAAA'
        command_off: 'JgCwBBE5EjoSOREABW+TlxE5EjoSOBEVEhQRFBAVEhMSORI6EDoTExEVEhQQFhEUEhUQOxEUERURFREVEhQQFhE5ExITOhI4ETgSOhE5EDoRAAVtlZYSORI5EToRFRAVERUSFBAWEToQORE5ERURFRMTEBQRFhEVETkRFRIUERQRFRAWERQROhIUEDsSOhE5EjkROxE4EgAFbpaXETkSOBE6EBUSFBEWEhMRFhE5EjkROxEUERURFREUEBYQFhA5ERYQFREVEBURFBIUEjkSExE6EjgSOhI5EjgRORMABW2VlxI4EToRORIVEBURFBEVEBQSOhI4EjgSFhAVERQRFRITExQQORIUEhQRFREVEBURFRE6EBQROhI4EjkRORI5EjkSAAVvlJYSORE4FDkSExIVERQSFBIUEjgSOhE5ERURFREUEhQRFREVETkSFBEVEBYRFREUERUROhIUEToRORI5EjgSOhI5EQAFbpaVETsSOBI6ERQRFBEWEBQRFRI5EjkSORITEhYQFRAVERURFBI5EhQRFREUERURFREUEjkSFBE6ETkSOBI7EDkROhIABW2WlhI4EzkROBIVERURFRAWERUROhE6ETgRFBIVERQRFREVEhYQOREWEBUQFRIUEhMRFRI4EhYQORI5EzcROhI5EjoSAAVtlJgSORE5EjoRFBITEhMSFREWETgSOxE5ERURFBEUEhUQFhEUEjkSExIVERURFRAVERUROREVEzgROxA6EDoSOBI5EQAFbpWWEToSOBM4ERUSFREVEBUQFRM4EjkROhEVERUQFREVERYRFBE6ERUSExIUERURFBEWEToRFBI5EjkSORM3DzwROhEABW+VlhE5EToSOREVEhUQFRAVERUSORI5EToRFBEUERYQFRIUEhQROhIVERQRFBIUERURFRA7EBQSOhE5EToRORM4EToQAAVulpcRORI5EDsSExAVERQSExIUEjkTOBI5EhQRFRAVERQRFRIUEToSFBEUEhQRFRAUERUSOREVEToQORM5EToRORM4EQAFb5WXEjkQORE6EhQRFREVEhMRFhE5ETkTOhETExQRFRAVEBUTFRE4ERUSFBETExQRFhEUEToRFRE6EDoROhE5ETkROxEABXCUlhM3EjsROREVEhQRFRAWERUQOhE6EjgRFBIUEhQRFhAVERUROhITERYRFBEUEhQSFBE6EhQROxA6ETkSORI5EjkSAAVulZYROxE5EjgRFREUERQTFBAWETkSORE5EhURFBEVERUSFBEUEToTExEVERURFBEUEhYQOhEUEjgTORI4EToSORI6EgAFbJaWEjkSORE4EhQSFBEVERQSFBI4EjkSOhEVEhMRFREVERUQFRE5EhURFBIWDxUQFRIUFDcRFRI3EjoSORI5EjYVOREABXCTlhI6EjgSORIWDxUSFBAVEhQSORE6ETkSFBIUERURFBIUEhUQOhEVERUQFRIUEhQRFRE6EhQSOhE5EjkROhM4EToRAAVulZYSORI5EjkTExEVEBUTFBAVEDwQORE7EhMSFBEUEhURFREVEDoRFREVERYQFRIUEhQRORIUEjgSORI5EjoSOBM4EAANBQAAAAAAAAAA'
  - name: "man-001"
    platform: mqtt
    state_topic: "man-001/espurna/relay/0"
    command_topic: "man-001/espurna/relay/0/set"
    payload_on: 1
    payload_off: 0
    optimistic: false
    qos: 1
    retain: true
    device:
      identifiers: man-001
      name: Living room light socket

apcupsd:

binary_sensor:
  - platform: apcupsd

light:
  - platform: switch
    name: Living Room light
    entity_id: switch.man_001
# Power sockets
tuya:
  username: !secret tuya_username
  password: !secret tuya_password
  country_code: 34
  platform: smart_life

speedtestdotnet:
  scan_interval:
    minutes: 35
  monitored_conditions:
    - ping
    - download
    - upload


# shell_command:
#   # https://philhawthorne.com/automating-your-shopping-list-with-home-assistant-and-grocy/
#   grocy_consume_item: "curl -X POST https://{{server_ip}}/api/stock/products/{{product_id}}/consume -H 'Accept: application/json' -H 'Content-Type: application/json' -H 'GROCY-API-KEY: {{grocy_key}}' -H 'cache-control: no-cache' -d '{ \"amount\": {{amount}},  \"transaction_type\": \"consume\",  \"spoiled\": false }'"


notify:
  # Also add in telegram bot section
  - name: manolo
    platform: telegram
    chat_id: !secret telegram_userid_manolo
  - name: monica
    platform: telegram
    chat_id: !secret telegram_userid_monica

person:
  - name: Manolo
    id: person_manolo
    user_id: !secret person_user_id_manolo
    device_trackers:
      - device_tracker.manolo_movil
      - device_tracker.manolo_pc7
      - !secret tile_device_manolo_keys

  - name: Monica
    id: person_monica
    user_id: !secret person_user_id_monica
    device_trackers:
      - device_tracker.moni_movil

zone:
  # This will override the default home zone
  - name: Home
    latitude: !secret momahome_latitude
    longitude: !secret momahome_longitude
    radius: 50
    icon: mdi:home-variant
  - name: Man-Work
    latitude: !secret manolo_work_latitude
    longitude: !secret manolo_work_longitude
    radius: 120
    icon: mdi:map-search

group: !include groups.yaml
automation: !include_dir_merge_list automations/
script: !include scripts.yaml
scene: !include scene.yaml
